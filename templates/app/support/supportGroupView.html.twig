{% extends "base.html.twig" %}
{% import "macros/view.html.twig" as utils %}

{% block title %}Suivi social | {{ title_website }}{% endblock %}

{% block body %}

<div class="container">

	<div class="d-flex mb-2">
		<h1 class="h2">Suivi social</h1>
		<div class="align-content-center"><a href="{{ path('support_edit', {'id': support.id }) }}" 
			class="text-{{ theme_color }} ml-2" title="Modifier le suivi"><span class="fas fa-edit"></span></a>
		</div>
	</div>

	{% include "model/msgFlash.html.twig" %}
	<div id="js-msg-flash-content"></div>

	{# {% cache "support.view" ~ support.id ~ support.updatedAt.timestamp support.updatedAt.timestamp %} #}

	{% set group_people = support.groupPeople %}
	<div class="small text-secondary">
		<p>Créé le {{support.createdAt|date("d/m/Y à H:i") }}{{ support.createdBy ? " par " ~ support.createdBy.fullname }}
			<span id="js-updatedSupport">(modifié le {{ support.updatedAt|date("d/m/Y à H:i") }} par {{ support.updatedBy.fullname }})</span>
		</p>
	</div>

	<nav aria-label="breadcrumb">
		<ol class="breadcrumb">
			<li class="breadcrumb-item">
				<a class="text-{{ theme_color }}" href="{{ path('group_people_show', {'id': group_people.id}) }}">
					<span class="fas fa-users mr-2"></span>Fiche groupe<span class="small"> {{ group_people.familyTypologyToString }}</span>
				</a>
			</li>
			<li class="breadcrumb-item active" aria-current="page">Suivi social (Accueil)</li>
		</ol>
	</nav>
	{% for person in support.supportPeople %}
		<a href="{{ path("group_person_show", {"id":group_people.id, "person_id":person.person.id, "slug":person.person.slug}) }}" 
			class="btn btn-outline-secondary btn-sm rounded-pill mb-2">{{ person.person.fullname }}</a>
	{% endfor %}

	<hr>

	<div class="d-flex row justify-content-center my-4">
		{% if support.service.accommodation %}
		<div class="col-6 col-sm-4 col-md-3 col-xl-2 mb-3">
			<a id='support-accommodations' class="btn btn-{{ theme_color }} btn-block shadow" 
			href="{{ path('support_accommodations', {'id':support.id}) }}" data-placement="bottom" 
			title="Modalités d'hébergement">Hébergement<span class="badge badge-light ml-2">{{ support.accommodationGroups|length }}</span></a>
		</div>
		<div class="col-6 col-sm-4 col-md-3 col-xl-2 mb-3">
			<a id='support-contributions' class="btn btn-{{ theme_color }} btn-block shadow" 
			href="{{ path('support_contributions', {'id':support.id}) }}" data-placement="bottom" 
			title="Redevances et participations financières">Redevances<span class="badge badge-light ml-2">{{ support.contributions|length }}</span></a>
		</div>
		{% endif %}
		<div class="col-6 col-sm-4 col-md-3 col-xl-2 mb-3">
			<a id='support-evaluation' class="btn btn-{{ theme_color }} btn-block shadow" 
			href="{{ path('support_evaluation_show', {'id':support.id}) }}" data-placement="bottom" 
			title="Évaluation sociale">Évaluation<span class="badge badge-light ml-2">{{ support.evaluationsGroup|length }}</span></a>
		</div>
		<div class="col-6 col-sm-4 col-md-3 col-xl-2 mb-3">
			<a id='support-calendar' class="btn btn-{{ theme_color }} btn-block shadow" 
				href="{{ path('support_calendar_show', {'id':support.id}) }}" data-placement="bottom" 
				title="Rendez-vous">Rendez-vous<span class="badge badge-light ml-2">{{ support.rdvs|length }}</span></a>
		</div>
		<div class="col-6 col-sm-4 col-md-3 col-xl-2 mb-3">
			<a id='support-notes' class="btn btn-{{ theme_color }} btn-block shadow" 
				href="{{ path('support_notes', {'id':support.id}) }}" data-placement="bottom" 
				title="Notes sociales et rapport">Notes<span class="badge badge-light ml-2">{{ support.notes|length }}</span></a>
		</div>
		<div class="col-6 col-sm-4 col-md-3 col-xl-2 mb-3">
			<a id='support-documents' class="btn btn-{{ theme_color }} btn-block shadow" 
				href="{{ path('support_documents', {'supportId':support.id}) }}"data-placement="bottom" 
				title="Documents administratifs">Documents<span class="badge badge-light ml-2">{{ support.documents|length }}</span></a>
		</div>
	</div>

	<div class="row">
		<div class="col-md-6 mb-1 py-2">
			<span class="py-2 text-secondary">Service (dispositif) : </span>
			<a href="{{ path('service_edit', {'id': support.service.id }) }}" class="text-{{ theme_color }}">
				{{ support.service.name ~ (support.device ? " (" ~ support.device.name ~ ")") }}</a>
		</div>
		{{ utils.view(support.statusToString ~ (support.endStatus ? " (" ~ support.endStatusToString ~ ")" : "" ), "Status") }}
		{% set originRequest = support.originRequest %}
		{% if originRequest %}
		{{ utils.view(originRequest.organization ? originRequest.organization.name ~ (originRequest.organizationComment ? " (" 
			~ originRequest.organizationComment ~ ")" : "") : "", "Organization", "support") }}
		{{ utils.view(originRequest.orientationDate ? originRequest.orientationDate|date("d/m/Y"), "Orientation date", "support") }}
		{% endif %}
	</div>
	<div class="row">
		{{ utils.view(support.startDate ? support.startDate|date("d/m/Y") 
			~ (support.endDate ? " - " ~ support.endDate|date("d/m/Y") : "") : "", "Date de suivi") }}
		{{ utils.view(support.referent ? support.referent.fullname ~ (support.referent2 ? " (" 
			~ support.referent2.fullname ~ ")" : "") : "", "Referent") }}
	</div>
	{% for accommodationGroup in support.accommodationGroups %}
		{% if loop.last %}
			<div class="row">
				{{ utils.view(accommodationGroup.startDate ? accommodationGroup.startDate|date("d/m/Y") 
					~ (accommodationGroup.endDate ? " - " ~ accommodationGroup.endDate|date("d/m/Y") : "") : "", "Date d'hébergement") }}
				{{ utils.view(accommodationGroup.accommodation ? accommodationGroup.accommodation.name ~ " (" 
					~ accommodationGroup.accommodation.address ~ ", " ~ accommodationGroup.accommodation.zipcode ~ " " 
					~ accommodationGroup.accommodation.city ~  ")" : "", "Hébergement") }}
				{{ utils.view(accommodationGroup.endReasonToString, "Motif de fin d'hébergement") }}
			</div>
		{% endif %}	
	{% endfor %}
	<div class="row">
		{{ utils.view(support.coefficient ? support.coefficient, "Coefficient") }}
	</div>
	<div class="row">
		{{ utils.view(support.comment, "Comment") }}
	</div>

	<div class="row mt-3">
		<div class="col-md-12">
			{% if is_granted("DELETE", support) %}
			<div class="float-left d-flex">
				<a id="modal-btn-delete" class="mr-3 btn btn-danger d-block" href="{{ path('support_delete', {'id':support.id}) }}"
					title="Supprimer le suivi social" data-placement="bottom"
					onclick="if(window.confirm('Tous les éléments rattachés au suivi vont être supprimés (évaluation sociale, RDVs, notes, documents...).Êtes-vous vraiment sûr de vouloir supprimer ce suivi social ?')){return true;}else{return false;}">
					<span class="fas fa-trash-alt mr-2"></span><span class="">Supprimer</span></a>
			</div>
			{% endif %}
			<div class="mb-3 float-right">
				<a href="{{ path('support_edit', {'id': support.id }) }}" id="support_edit" class="btn btn-{{ theme_color }} shadow"><span 
					class="fas fa-edit mr-2"></span>Modifier</a>
			</div>
		</div>
	</div>

	{# {% endcache %} #}

	{% if evaluation %}
		<hr>
		<div class="row">
			<div class="col-md-12 mb-2">
				<div class="float-right">
					<a href="{{ path('support_note_new_evaluation', {'id': support.id }) }}" class="btn btn-{{ theme_color }} shadow"
						title="Générer une note sociale à partir de l'évaluation ci-dessous">
						<span class="fas fa-sticky-note mr-2"></span>Générer rapport social</a>
				</div>
			</div>
		</div>	
		{# {% cache "evaluation.view" ~ evaluation.id ~ evaluation.updatedAt.timestamp evaluation.updatedAt.timestamp %} #}
		{% include "app/evaluation/evaluationView.html.twig" %}
		{# {% endcache %} #}
	{% endif %}

</div>

{% endblock %}