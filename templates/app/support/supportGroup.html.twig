{% extends "base.html.twig" %}

{% form_theme form "form/bootstrap_4_horizontal.html.twig" %}

{% if edit_mode %}
	{% set people = form.vars.value.supportPerson %}
	{% set title = "Suivi social" %}
{% else %}
	{% set people = group_people.rolePerson %}
	{% set title = "Nouveau suivi social" %}
{% endif %}

{% block title %}
{{ title }} | Esperer95.app
{% endblock %}

{% block body %}

<div class="container">

	{% if group_people is not defined %}
	{% set group_people = form.vars.value.groupPeople %}
	{% endif %}

	{% set typo = group_people.familyTypology %}
	{% set support = form.vars.value %}

	<h1 class="h2 mb-3">{{ title }}</h1>
	{% if edit_mode %}
	<div class="small text-secondary">
		<p>
			Créé le {{support.createdAt | date("d/m/Y à H:i") }}
			{% if support.createdBy %}par {{ support.createdBy.fullname}}{% endif %}
			<span id="js-updatedSupport">(modifié le {{ support.updatedAt | date("d/m/Y à H:i") }} par {{ support.updatedBy.fullname }})</span>
		</p>
	</div>
	{% else %}
	<div class="mb-4"></div>
	{% endif %}

	<nav aria-label="breadcrumb">
		<ol class="breadcrumb">
			<li class="breadcrumb-item">
				<a class="text-{{ theme_color }}" href="{{ path('group_people_show', {'id': group_people.id}) }}">
					<span class="fas fa-users mr-2"></span>Fiche groupe
					<span class="small">{{ group_people.familyTypologyType }}</span>
				</a>
			</li>
			<li class="breadcrumb-item active" aria-current="page">
				{% if edit_mode %}Suivi social{% else %}Nouveau suivi social{% endif %}
			</li>
		</ol>
	</nav>
	{% for person in people %}
		<a href="{{ path("group_person_show", {"id":group_people.id, "person_id":person.person.id, "slug":person.person.slug}) }}" 
			class="btn btn-outline-{{ theme_color }} btn-sm mb-2">{{ person.person.fullname }}</a>
	{% endfor %}

	<hr>

	{{ form_start(form) }}


	{% include "model/msgFlash.html.twig" %}
	<div id="js-msg-flash-content"></div>

	{% if edit_mode %}
		<div class="d-flex row justify-content-center my-4">
			{% if support.service.preAdmission %}
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a class="btn btn-{{ theme_color }} btn-block shadow" href="{{ path('support_originRequest', {'id':support.id}) }}" data-placement="bottom" title="Origine de la demande et pré-admission">Origine demande</a>
			</div>			
			{% endif %}
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a class="btn btn-{{ theme_color }} btn-block shadow" href="{{ path('support_pers_edit', {'id':support.id}) }}" data-placement="bottom" title="Personnes attachées au suivi social">Personnes</a>
			</div>
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a class="btn btn-{{ theme_color }} btn-block shadow" href="{{ path('support_evaluation_show', {'id':support.id}) }}" data-placement="bottom" title="Évaluation sociale">Évaluation<span class="badge badge-light ml-2">{{ support.evaluationsGroup|length }}</span></a>
			</div>
			{% if support.service.accommodation %}
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a class="btn btn-{{ theme_color }} btn-block shadow" href="{{ path('support_accommodations', {'id':support.id}) }}" data-placement="bottom" title="Mdalités d'hébergement">Hébergement<span class="badge badge-light ml-2">{{ support.accommodationGroups|length }}</span></a>
			</div>
			{#<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
			<a class="btn btn-{{ theme_color }} btn-block shadow" href="#" data-placement="bottom" title="Voir les participations financières">Redevance</a>
			</div> #}
			{% endif %}
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a href="{{ path('support_calendar_show', {'id':support.id}) }}" class="btn btn-{{ theme_color }} btn-block shadow" data-placement="bottom" title="Rendez-vous">Rendez-vous<span class="badge badge-light ml-2">{{ support.rdvs|length }}</span></a>
			</div>
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a href="{{ path('notes', {'id':support.id}) }}" class="btn btn-{{ theme_color }} btn-block shadow" data-placement="bottom" title="Notes sociales et rapport">Notes<span class="badge badge-light ml-2">{{ support.notes|length }}</span></a>
			</div>
			<div class="col-6 col-sm-4 col-md-3 col-lg-2 mb-3">
				<a href="{{ path('documents', {'id':support.id}) }}" class="btn btn-{{ theme_color }} btn-block shadow" data-placement="bottom" title="Documents administratifs">Documents<span class="badge badge-light ml-2">{{ support.documents|length }}</span></a>
			</div>
		</div>
	{% endif %}

	{% if form.vars.value.evaluationsGroup|last %}
	{% set evaluation = form.vars.value.evaluationsGroup|last %}
	{% if evaluation.evalHousingGroup and evaluation.evalHousingGroup.housingAddress %}

	<div class="form-group row">
		<div class="col-4 col-sm-2">Adresse du logement ou hébergement :</div>
		<div class="col-8 col-sm-4">
			<div class="p-2">
				{{ evaluation.evalHousingGroup.housingAddress }}
				{% if evaluation.evalHousingGroup.housingDept %} - {{ evaluation.evalHousingGroup.housingDept }}{% endif %}
				{% if evaluation.evalHousingGroup.housingCity %} - {{ evaluation.evalHousingGroup.housingCity }}{% endif %}
			</div>
		</div>
	</div>

	{% endif %}
	{% endif %}

	<div class="form-group row">
		<div class="col-md-6">{{ form_row(form.service) }}</div>
		<div class="col-md-6">{{ form_row(form.device) }}</div>
	</div>
	<div class="form-group row">
		<div class="col-md-6">{{ form_row(form.status) }}</div>
	</div>
	<div class="form-group row">
		<div class="col-md-6">{{ form_row(form.startDate) }}</div>
		<div class="col-md-6">{{ form_row(form.endDate) }}</div>
	</div>
	<div class="form-group row">
		<div class="col-md-6 js-status d-block">{{ form_row(form.endStatus) }}</div>
		<div class="col-md-6 js-status d-block">{{ form_row(form.endStatusComment) }}</div>
	</div>
	<div class="form-group row">
		<div class="col-md-6">{{ form_row(form.referent) }}</div>
		<div class="col-md-6">{{ form_row(form.referent2) }}</div>
	</div>
	<div class="form-group row">
		<div class="col-md-12">{{ form_widget(form.comment) }}</div>
	</div>

	<div class="form-group row">
		<div class="col-md-12"> 
			<div class="card border-warning"> 
				<div class="card-body p-3"> 
					<p class="mb-2"><span class="font-italic">Je certifie avoir informé la personne sur ses droits (droit d'opposition, droits d'accès et de rectification) et avoir obtenu son consentement pour le recueil de ses données personnelles</span>
					 (<a href="https://www.cnil.fr/fr/respecter-les-droits-des-personnes" target="_blank" 	class="text-{{ theme_color }}">article 32 de la loi Informatique et Libertés</a>).</p>
					<div class="custom-control custom-checkbox custom-checkbox-{{ theme_color }} p-1">
						{{ form_widget(form.agreement) }}
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="form-group row mt-5">
		<div class="col-md-12">
			{% if edit_mode and is_granted("DELETE", support) %}
			<div class="float-left d-flex">
				<a id="modal-btn-delete" class="mr-3 btn btn-danger d-block" href="{{ path('support_delete', {'id':support.id}) }}"
					title="Supprimer le suivi social" data-placement="bottom"
					onclick="if(window.confirm('Tous les éléments rattachés au suivi vont être supprimés (évaluation sociale, RDVs, notes, documents...). Êtes-vous vraiment sûr de vouloir supprimer ce suivi social ?')){return true;}else{return false;}"><span
					class="fas fa-trash-alt mr-2"></span><span class="">Supprimer</span></a>
			</div>
			{% endif %}
			<div class="mb-4 float-right">
                <button type="submit" id="send" name="send" class="btn btn-{{ theme_color }} shadow"><span class="fas fa-save mr-2"></span>{% if edit_mode %}Mettre à jour{% else %}Enregistrer{% endif %}</button>
			</div>
		</div>
	</div>

	{{ form_row(form._token) }}
	{{ form_end(form, {"render_rest": false}) }}

	{# {% include "app/document/modalDeleteSupport.html.twig" %} #}
</div>

{% endblock %}

{% block javascripts %}
{{ encore_entry_script_tags("support") }}
{% endblock javascripts %}
